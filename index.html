<!DOCTYPE html>
<html lang="en">
<head>
  <title>과제 CRUD</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>

  <style>
    .form-group { margin-bottom: 10px; }
    .task-card { padding: 12px; margin-bottom: 10px; background-color: #faf3f3; }
    .task-header { font-weight: bold; font-size: 16px; }
    .task-detail { margin-top: 4px; font-size: 14px; }
  </style>
</head>

<body>
<nav class="navbar navbar-inverse">
  <div class="container-fluid">
    <div class="navbar-header"><a class="navbar-brand" href="#">Logo</a></div>
    <ul class="nav navbar-nav">
      <li class="active"><a href="#">Home</a></li>
      <li><a href="#">About</a></li>
    </ul>
  </div>
</nav>

<div class="container">

  <h2>CRUD Program</h2>
  <button id="openAddModal" class="btn btn-success">Add</button>
  <button id="btnStu" class="btn btn-primary">Bring Data</button>

  <div id="itemList" style="margin-top:20px;"></div>
</div>

<div id="taskModal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">

      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal">&times;</button>
        <h4 id="modalTitle">New Task</h4>
      </div>

      <div class="modal-body">
        <input type="hidden" id="taskId">

        <div class="form-group">
          <label>Title</label>
          <input type="text" id="title" class="form-control">
        </div>

        <div class="form-group">
          <label>Due Day</label>
          <input type="date" id="due" class="form-control">
        </div>

        <div class="form-group">
          <label>Detail</label>
          <input type="text" id="detail" class="form-control">
        </div>

        <div class="form-group">
          <label>Finish</label>
          <select id="finish" class="form-control">
            <option value="">Select</option>
            <option value="Yes">Yes</option>
            <option value="No">No</option>
          </select>
        </div>

        <div class="form-group">
          <label>Priority</label>
          <select id="priority" class="form-control">
            <option value="">Select</option>
            <option value="Low">Low</option>
            <option value="Medium">Medium</option>
            <option value="High">High</option>
          </select>
        </div>

        <div class="form-group">
          <label>Category</label>
          <input type="text" id="category" class="form-control">
        </div>
      </div>

      <div class="modal-footer">
        <button id="saveBtn" class="btn btn-success">Save</button>
      </div>

    </div>
  </div>
</div>

<script>
const API = "https://6910cb5a7686c0e9c20bb7c5.mockapi.io/Tasks";

$(document).ready(function () {
  $("#openAddModal").click(function () {
    $("#modalTitle").text("New Task");
    $("#taskId").val("");
    $("#title").val("");
    $("#due").val("");
    $("#detail").val("");
    $("#finish").val("");
    $("#priority").val("");
    $("#category").val("");
    $("#taskModal").modal("show");
  });

  $("#saveBtn").click(function () {
    const id = $("#taskId").val();
    const data = {
      title: $("#title").val(),
      dueDay: $("#due").val(),
      detail: $("#detail").val(),
      finish: $("#finish").val(),
      priority: $("#priority").val(),
      category: $("#category").val()
    };
    if (!data.title || !data.dueDay) {
      alert("Title과 Due Day는 필수입니다.");
      return;
    }
    if (id === "")
      fetch(API, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(data) })
        .then(res => { if (!res.ok) throw new Error("POST 실패 " + res.status); return res.json(); })
        .then(() => { $("#taskModal").modal("hide"); getStudents(); })
        .catch(err => { console.error(err); alert("저장 중 오류: " + err.message); });
    else
      fetch(API + "/" + id, { method: "PUT", headers: { "Content-Type": "application/json" }, body: JSON.stringify(data) })
        .then(res => { if (!res.ok) throw new Error("PUT 실패 " + res.status); return res.json(); })
        .then(() => { $("#taskModal").modal("hide"); getStudents(); })
        .catch(err => { console.error(err); alert("수정 중 오류: " + err.message); });
  });

  getStudents();
});

function safeParseTextResponse(res) {
  return res.text().then(text => {
    try { return JSON.parse(text); }
    catch (e) {
      try {
        const cleaned = text.trim();
        return JSON.parse(cleaned);
      } catch (e2) {
        return text;
      }
    }
  });
}

function normalizeItem(item) {
  return {
    id: item.id || item.tasks || item.Tasks || "",
    title: item.title || item.Title || "",
    dueDay: item.dueDay || item.DueDay || item.due || item.Due || "",
    detail: item.detail || item.Detail || "",
    finish: item.finish || item.Finish || "",
    priority: item.priority || item.Priority || "",
    category: item.category || item.Category || ""
  };
}

function getStudents() {
  fetch(API)
    .then(res => {
      console.log("응답 상태:", res.status, res.statusText);
      return safeParseTextResponse(res);
    })
    .then(rawData => {
      console.log("응답 데이터:", rawData);
      let arr = [];
      if (Array.isArray(rawData)) arr = rawData;
      else if (typeof rawData === "string" && rawData.length === 0) arr = [];
      else if (rawData && typeof rawData === "object") arr = [rawData];
      else {
        try { arr = JSON.parse(rawData); } catch { arr = []; }
      }
      const normalized = arr.map(normalizeItem);
      console.log("정규화된 데이터:", normalized);
      $("#itemList").html(makeList(normalized));
    })
}

function makeList(data) {
  let str = "";
  data.forEach(t => {
    str += `
      <div class="task-card">
        <div class="task-header">${escapeHtml(t.title)}</div>
        <div class="task-detail">마감일: ${escapeHtml(t.dueDay)}</div>
        <div class="task-detail">내용: ${escapeHtml(t.detail)}</div>
        <div class="task-detail">완료: ${escapeHtml(t.finish)}</div>
        <div class="task-detail">우선순위: ${escapeHtml(t.priority)}</div>
        <div class="task-detail">카테고리: ${escapeHtml(t.category)}</div>
        <button class="btn btn-primary" onclick="editTask('${t.id}')">Modify</button>
        <button class="btn btn-danger" onclick="deleteTask('${t.id}')">Delete</button>
      </div>`;
  });
  return str;
}

function escapeHtml(str) {
  if (str === null || str === undefined) return "";
  return String(str);
}

function editTask(id) {
  fetch(API + "/" + id)
    .then(res => {
      console.log("editTask 응답 상태:", res.status);
      return safeParseTextResponse(res);
    })
    .then(raw => {
      const item = (typeof raw === "object") ? raw : (Array.isArray(raw) ? raw[0] : {});
      const n = normalizeItem(item);
      $("#modalTitle").text("Modify Task");
      $("#taskId").val(n.id);
      $("#title").val(n.title);
      $("#due").val(n.dueDay);
      $("#detail").val(n.detail);
      $("#finish").val(n.finish);
      $("#priority").val(n.priority);
      $("#category").val(n.category);
      $("#taskModal").modal("show");
    })
    
}

function deleteTask(id) {
  if (!confirm("정말 삭제하시겠습니까?")) return;
  fetch(API + "/" + id, { method: "DELETE" })
    .then(res => {
      if (!res.ok) throw new Error("삭제 실패 " + res.status);
      return res.json();
    })
    .then(() => getStudents())
    
}
</script>

</script>

</body>
</html>
